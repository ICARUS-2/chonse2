<div class="componentContainer">
    <div class="boardOuterContainer" [class]="isFlipped ? 'boardOuterContainerFlipped' : ''">
        <app-captured-pieces for="b" [capturedPieces]="chessGame.piecesBlackCaptured" [advantage]="chessGame.getMaterialAdvantage()"></app-captured-pieces>
        <div class="boardContainerInner" [class]="isFlipped ? 'boardContainerInnerFlipped' : ''">
            @for( rank of chessGame.pieceState; let rankIndex = $index; track rankIndex)
            {
                <ng-container>
                    @for ( piece of rank; let fileIndex = $index; track fileIndex; )
                    {
                        <div style="position: relative; width: 100%; height: 100%;">
                            <app-square 
                                [coordinate]="this.COORDS[rankIndex][fileIndex]" 
                                [piece]="chessGame.pieceState[rankIndex][fileIndex]"
                                [isDark]="(rankIndex + fileIndex) % 2 == 1"
                                [showFile]="rankIndex == rank.length - 1"
                                [showRank]="fileIndex == 0"
                                [showPiece]="this.COORDS[rankIndex][fileIndex] != fromSquare"
                                [isFlipped]="isFlipped"
                                [isLegalMove]="currentLegalMoves.includes(this.COORDS[rankIndex][fileIndex])"
                                [isInCheck]="(chessGame.pieceState[rankIndex][fileIndex] == pieceType.WHITE_KING && chessGame.isInCheck(pieceColor.WHITE)) || (chessGame.pieceState[rankIndex][fileIndex] == pieceType.BLACK_KING && chessGame.isInCheck(pieceColor.BLACK)) "
                                (mouseDown)="onSquareMouseDown($event)"
                                (mouseUp)="onSquareMouseUp($event)">
                            </app-square>

                            @if (_isSquareEndgameKingSquare(rankIndex, fileIndex))
                            {
                                <div class="endgameSquareOverlay" 
                                [ngClass]="{'endgameSquareOverlayFlipped': isFlipped}">
                                    <div class="fade-out-bg endgameSquareBackground"
                                        [style]="{'background-color' : _getEndgameSquareBackgroundColor(rankIndex, fileIndex)}">
                                    </div>

                                    <img class="move-up-right-shrink endgameSquareImage"
                                        [src]="_getEndgameSquareImgSrc(rankIndex, fileIndex)"
                                        style="width: 10vmin;" />

                                    <div class="corner-text fade-out-bg"
                                        [style]="{'background-color' : _getEndgameSquareBackgroundColor(rankIndex, fileIndex)}">
                                        {{_getEndgameSquareText(rankIndex, fileIndex)}}
                                    </div>
                                </div>
                            }

                        </div>
                    }
                </ng-container>
            }
        </div>

        <app-captured-pieces for="w" [capturedPieces]="chessGame.piecesWhiteCaptured" [advantage]="chessGame.getMaterialAdvantage()"></app-captured-pieces>
    </div>
    <div class="boardControls p-5">
        <h2>Controls</h2>
        <div class="btn btn-primary" (click)="handleFlipClicked()">↑↓</div>
        <p>{{chessGame.turn ? "White" : "Black"}} to move</p>

        <p>Touch to move: {{localStorageHelper.getValue(localStorageHelper.CLICK_TO_MOVE)}}</p>
        <input
            class="form-check-input"
            type="checkbox"
            id="darkModeSwitch"
            [(ngModel)]="clickToMove"
            (ngModelChange)="handleClickToMoveSwitchPressed($event)"
        />
        
        <div class="testingPurposes">
            @if(this.chessGame.gameState.isGameOver)
            {
                <p>Result: {{this.chessGame.gameState.reason}}</p>
            }
        </div>
    </div>
    @if(currentlyHeldPiece != "")
    {
        <img class="currentlyHeldPiece"
            [src]="`piece/merida/${currentlyHeldPiece}.svg`"
            [style.left.px]="mouseX"
            [style.top.px]="mouseY">
    }
</div>