<div class="componentContainer">
    <div class="boardOuterContainer" [class]="isFlipped ? 'boardOuterContainerFlipped' : ''">
        <app-captured-pieces for="b" [capturedPieces]="chessGame.piecesBlackCaptured" [advantage]="chessGame.getMaterialAdvantage()"></app-captured-pieces>
        <div class="boardContainerInner" [class]="isFlipped ? 'boardContainerInnerFlipped' : ''">
            @for( rank of chessGame.pieceState; let rankIndex = $index; track rankIndex)
            {
                <ng-container>
                    @for ( piece of rank; let fileIndex = $index; track fileIndex; )
                    {
                        <div style="position: relative; width: 100%; height: 100%;">
                            <app-square 
                                [coordinate]="this.COORDS[rankIndex][fileIndex]" 
                                [piece]="chessGame.pieceState[rankIndex][fileIndex]"
                                [isDark]="(rankIndex + fileIndex) % 2 == 1"
                                [showFile]="rankIndex == rank.length - 1"
                                [showRank]="fileIndex == 0"
                                [showPiece]="this.COORDS[rankIndex][fileIndex] != fromSquare"
                                [isFlipped]="isFlipped"
                                [isLegalMove]="currentLegalMoves.includes(this.COORDS[rankIndex][fileIndex])"
                                [isInCheck]="(chessGame.pieceState[rankIndex][fileIndex] == pieceType.WHITE_KING && chessGame.isInCheck(pieceColor.WHITE)) || (chessGame.pieceState[rankIndex][fileIndex] == pieceType.BLACK_KING && chessGame.isInCheck(pieceColor.BLACK)) "
                                (mouseDown)="onSquareMouseDown($event)"
                                (mouseUp)="onSquareMouseUp($event)">
                            </app-square>

                            @if (_isSquareEndgameKingSquare(rankIndex, fileIndex))
                            {
                                <div class="endgameSquareOverlay" 
                                [ngClass]="{'endgameSquareOverlayFlipped': isFlipped}">
                                    <div class="fade-out-bg endgameSquareBackground"
                                        [style]="{'background-color' : _getEndgameSquareBackgroundColor(rankIndex, fileIndex)}">
                                    </div>

                                    <img class="move-up-right-shrink endgameSquareImage"
                                        [src]="_getEndgameSquareImgSrc(rankIndex, fileIndex)"
                                        style="width: 10vmin;" />

                                    <div class="corner-text fade-out-bg"
                                        [style]="{'background-color' : _getEndgameSquareBackgroundColor(rankIndex, fileIndex)}">
                                        {{_getEndgameSquareText(rankIndex, fileIndex)}}
                                    </div>
                                </div>
                            }

                        </div>
                    }
                </ng-container>
            }
        </div>

        <app-captured-pieces for="w" [capturedPieces]="chessGame.piecesWhiteCaptured" [advantage]="chessGame.getMaterialAdvantage()"></app-captured-pieces>
    </div>
    <div class="boardControls p-5">
        <h2>Controls</h2>
        <div class="btn btn-primary" (click)="handleFlipClicked()">↑↓</div>
        <p>{{chessGame.turn ? "White" : "Black"}} to move</p>

        <div class="testingPurposes">
            <!--<p>CURRENT PIECE: {{currentlyHeldPiece}}</p>
            <p>LEGAL MOVES: {{ currentLegalMoves.toString() }}</p>
            <p>WHITE CASTLING RIGHTS: {{ `Kingside: ` + this.chessGame.whiteCastlingRights.kingSide + ` |  Queenside: ` + this.chessGame.whiteCastlingRights.queenSide }}</p>
            <p>BLACK CASTLING RIGHTS: {{ `Kingside: ` + this.chessGame.blackCastlingRights.kingSide + ` |  Queenside: ` + this.chessGame.blackCastlingRights.queenSide }}</p>
            <p>EN PASSANT: {{chessGame.enPassantSquare}}</p>
            <p>WHITE IS IN CHECK: {{chessGame.isInCheck("w")}}</p>
            <p>BLACK IS IN CHECK: {{chessGame.isInCheck("b")}}</p>-->
            <p>Game is Over: {{chessGame.gameState.isGameOver}}</p>
            <p>Reason: {{chessGame.gameState.reason.toString()}}</p>
            <p>White pieces: {{chessGame._getAllPiecesAndCoordsByColor("w").pieces}}</p>
            <p>White piece coords: {{chessGame._getAllPiecesAndCoordsByColor("w").coords}}</p>
            <p>Black pieces: {{chessGame._getAllPiecesAndCoordsByColor("b").pieces}}</p>
            <p>Black piece coords: {{chessGame._getAllPiecesAndCoordsByColor("b").coords}}</p>
        </div>
    </div>
    @if(currentlyHeldPiece != "")
    {
        <img class="currentlyHeldPiece"
            [src]="`piece/merida/${currentlyHeldPiece}.svg`"
            [style.left.px]="mouseX"
            [style.top.px]="mouseY">
    }
</div>