<div class="componentContainer">
    <div class="boardOuterContainer" [class]="boardState.isFlipped ? 'boardOuterContainerFlipped' : ''">
        <app-captured-pieces for="b" [capturedPieces]="boardState.getCurrentState().piecesBlackCaptured" [advantage]="boardState.getCurrentState().getMaterialAdvantage()"></app-captured-pieces>
        <div class="boardContainerInner" [class]="boardState.isFlipped ? 'boardContainerInnerFlipped' : ''">
            
            <!-- ARROW OVERLAY -->
            <svg
                class="arrowOverlay"
                [attr.viewBox]="'0 0 8 8'"
                preserveAspectRatio="none">
                @for( arrow of arrows; track $index )
                {
                    <ng-container>
                        <line
                            [attr.x1]="_getArrowCoords(arrow).x1"
                            [attr.y1]="_getArrowCoords(arrow).y1"
                            [attr.x2]="_getArrowCoords(arrow).x2"
                            [attr.y2]="_getArrowCoords(arrow).y2"
                            [attr.stroke]="arrow.color"
                            stroke-width="0.13"
                            marker-end="url(#arrowhead)" />
                    </ng-container>

                }

                <defs>
                    <marker
                        id="arrowhead"
                        markerWidth="3"
                        markerHeight="3"
                        refX="1.5"
                        refY="1.5"
                        orient="auto"
                        markerUnits="strokeWidth">
                        <polygon points="0 0, 3 1.5, 0 3" fill="context-stroke" />
                    </marker>
                </defs>
            </svg>
            @for( rank of boardState.getCurrentState().pieceState; let rankIndex = $index; track rankIndex)
            {
                <ng-container>
                    @for ( piece of rank; let fileIndex = $index; track fileIndex; )
                    {
                        <div style="position: relative; width: 100%; height: 100%;">
                            <app-square 
                                [coordinate]="this.COORDS[rankIndex][fileIndex]" 
                                [piece]="boardState.getCurrentState().pieceState[rankIndex][fileIndex]"
                                [isDark]="(rankIndex + fileIndex) % 2 == 1"
                                [showFile]="rankIndex == rank.length - 1"
                                [showRank]="fileIndex == 0"
                                [showPiece]="(this.COORDS[rankIndex][fileIndex] != fromSquare) || localStorageHelper.getBoolean(localStorageHelper.CLICK_TO_MOVE)"
                                [isFlipped]="boardState.isFlipped"
                                [isLegalMove]="currentLegalMoves.includes(this.COORDS[rankIndex][fileIndex])"
                                [isInCheck]="(boardState.getCurrentState().pieceState[rankIndex][fileIndex] == pieceType.WHITE_KING && boardState.getCurrentState().isInCheck(pieceColor.WHITE)) || (boardState.getCurrentState().pieceState[rankIndex][fileIndex] == pieceType.BLACK_KING && boardState.getCurrentState().isInCheck(pieceColor.BLACK)) "
                                [isClicked]="getRightClickedStatusForSquare(this.COORDS[rankIndex][fileIndex])"
                                (mouseDown)="onSquareMouseDown($event)"
                                (mouseUp)="onSquareMouseUp($event)"
                                (leftClick)="onSquareLeftClick()">
                            </app-square>

                            @if (_isSquareEndgameKingSquare(rankIndex, fileIndex))
                            {
                                <div class="endgameSquareOverlay" 
                                [ngClass]="{'endgameSquareOverlayFlipped': boardState.isFlipped}">
                                    <div class="fade-out-bg endgameSquareBackground"
                                        [style]="{'background-color' : _getEndgameSquareBackgroundColor(rankIndex, fileIndex)}">
                                    </div>

                                    <img class="move-up-right-shrink endgameSquareImage"
                                        [src]="_getEndgameSquareImgSrc(rankIndex, fileIndex)"
                                        style="width: 10vmin;" />

                                    <div class="corner-text fade-out-bg"
                                        [style]="{'background-color' : _getEndgameSquareBackgroundColor(rankIndex, fileIndex)}">
                                        {{_getEndgameSquareText(rankIndex, fileIndex)}}
                                    </div>
                                </div>
                            }

                        </div>
                    }
                </ng-container>
            }
        </div>

        <app-captured-pieces for="w" [capturedPieces]="boardState.getCurrentState().piecesWhiteCaptured" [advantage]="boardState.getCurrentState().getMaterialAdvantage()"></app-captured-pieces>
    </div>
    <div class="boardControls p-5">
        <div class="boardControlButtons">
            <div class="btn btn-lg btn-primary controlButton" [ngClass]="areBackButtonsEnabled() ? '' : 'disabled'" (click)="handleDoubleBackButtonClicked()">&lt;&lt;-</div>
            <div class="btn btn-lg btn-primary controlButton" [ngClass]="areBackButtonsEnabled() ? '' : 'disabled'" (click)="handleBackButtonClicked()">&lt;</div>
            <div class="btn btn-lg btn-primary controlButton" [ngClass]="areForwardButtonsEnabled() ? '' : 'disabled'" (click)="handleForwardButtonClicked()">></div>
            <div class="btn btn-lg btn-primary controlButton" [ngClass]="areForwardButtonsEnabled() ? '' : 'disabled'" (click)="handleDoubleForwardButtonClicked()">->></div>
        </div>
        <div class="btn btn-primary controlButton" (click)="handleFlipClicked()">↑↓</div>

        <p>{{boardState.getCurrentState().turn ? "White" : "Black"}} to move</p>

        <div class="algebraicContainer">
            @for (item of boardState.mainMoveStack; track $index) 
            {
                @if ($index % 2 == 0)
                {
                    <div>
                        <p class="d-inline move-number">{{ ($index / 2) + 1 }}. </p>
                        <p 
                            class="d-inline" 
                            [ngClass]="{
                                'text-primary' : $index == boardState.mainStackPointer - 1 && boardState.divergenceStack.length == 0,
                                'text-danger' : $index == boardState.mainStackPointer - 1 && boardState.divergenceStack.length != 0}"
                                >{{item.notation}} 
                        </p>
                        <p class="d-inline" 
                            [ngClass]="{
                                'text-primary' : $index == boardState.mainStackPointer - 2 && boardState.divergenceStack.length == 0,
                                'text-danger' : $index == boardState.mainStackPointer - 2 && boardState.divergenceStack.length != 0}"
                                >{{boardState.mainMoveStack[$index + 1] == null ? "-" : boardState.mainMoveStack[$index + 1].notation}} </p>
                    </div>   
                }
            }
        </div>

        <div class="testingPurposes">
            @if(this.boardState.getCurrentState().gameState.isGameOver)
            {
                <p>Result: {{this.boardState.getCurrentState().gameState.reason}}</p>
            }
        </div>
    </div>
    @if(currentlyHeldPiece != "")
    {
        <img class="currentlyHeldPiece"
            [src]="`piece/merida/${currentlyHeldPiece}.svg`"
            [style.left.px]="mouseX"
            [style.top.px]="mouseY">
    }
</div>